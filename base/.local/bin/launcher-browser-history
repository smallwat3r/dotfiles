#!/usr/bin/env bash
#
# launcher-browser-history - Browse Chrome/Chromium bookmarks and history
#
# Interactively select a URL from your browser bookmarks or history
# and open it in Chrome/Chromium.
#
# Dependencies:
#   - fzf: Fuzzy finder
#   - sqlite3: For reading history database
#   - jq: For parsing bookmarks JSON
#
# Usage:
#   launcher-browser-history
#
set -euo pipefail

# Helpers

die() { echo "$1" >&2; exit 1; }

has() { command -v "$1" >/dev/null 2>&1; }

require() { has "$1" || die "$1 is required"; }

# Dependencies

require fzf
require sqlite3
require jq

# Config

case "$(uname -s)" in
  Darwin)
    HISTORY="$HOME/Library/Application Support/Google/Chrome/Default/History"
    fzf_bind="alt-left:backward-word,alt-right:forward-word,alt-bs:backward-kill-word,home:first,end:last"

    open_url() { open -a "/Applications/Google Chrome.app" "$1"; }
    ;;
  Linux)
    HISTORY=""
    for path in \
      "$HOME/.config/chromium/Default/History" \
      "$HOME/.config/google-chrome/Default/History" \
      "$HOME/.var/app/org.chromium.Chromium/config/chromium/Default/History" \
      "$HOME/.var/app/com.google.Chrome/config/google-chrome/Default/History" \
      "$HOME/snap/chromium/common/chromium/Default/History"
    do
      [[ -f "$path" ]] && HISTORY="$path" && break
    done
    fzf_bind="ctrl-left:backward-word,ctrl-right:forward-word,ctrl-bs:backward-kill-word,home:first,end:last"

    open_url() { setsid xdg-open "$1" >/dev/null 2>&1; }
    ;;
  *)
    die "Unsupported OS"
    ;;
esac

[[ -f "$HISTORY" ]] || die "History file not found"

BOOKMARKS="${HISTORY%History}Bookmarks"

fzf_colors="bg:-1,bg+:-1,fg:-1,fg+:-1,hl:33,hl+:33,info:30,prompt:30,pointer:32,marker:32,spinner:32"

# Functions

fzf_pick() {
  fzf --reverse --wrap --tiebreak=index --bind="$fzf_bind" --color="$fzf_colors"
}

list_entries() {
  local jq_filter='.. | select(.type? == "url") | "üîñ [\(.name)]\t\(.url)"'
  local sql_query="
    SELECT 'üïê ' || date(last_visit_time/1000000 - 11644473600, 'unixepoch') || ' ' || url
    FROM urls
    ORDER BY last_visit_time DESC
    LIMIT 100000
  "

  [[ -f "$BOOKMARKS" ]] && jq -r "$jq_filter" "$BOOKMARKS" || true
  sqlite3 "file:$HISTORY?immutable=1" "$sql_query"
}

extract_url() {
  local target="$1"

  if [[ "$target" == *$'\t'* ]]; then
    printf '%s' "${target##*$'\t'}"
  else
    printf '%s' "${target#* * }"
  fi
}

# Main

target="$(list_entries | fzf_pick)" || exit 0

open_url "$(extract_url "$target")"

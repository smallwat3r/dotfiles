#!/usr/bin/env bash
#
# launcher-clipboard-history - Browse and select from clipboard history
#
# Interactively select an entry from your clipboard history and copy
# it back to the clipboard.
#
# Dependencies: fzf, (cliphist + wl-copy) or (gpaste-client) or (greenclip + xclip)
#
set -euo pipefail

. "${HOME}/.local/lib/launcher.sh"

require fzf

# Select backend based on environment
if is_wlroots && has cliphist && has wl-copy; then
    list_history() { cliphist list; }
    select_item() { printf '%s' "$1" | cliphist decode | wl-copy; }
elif has gpaste-client && ! is_wlroots; then
    list_history() {
        gpaste-client --oneline | while IFS=: read -r uuid content; do
            printf '%s\t%s\n' "$uuid" "${content# }"
        done
    }
    select_item() { gpaste-client select "${1%%$'\t'*}"; }
elif has cliphist && has wl-copy; then
    list_history() { cliphist list; }
    select_item() { printf '%s' "$1" | cliphist decode | wl-copy; }
elif has greenclip && has xclip; then
    list_history() { greenclip print; }
    select_item() { printf '%s' "$1" | xclip -selection clipboard; }
else
    die "No clipboard history tool found (cliphist, gpaste-client, or greenclip)"
fi

selected="$(list_history | fzf_pick_id)" || exit 0
[[ -z "$selected" ]] && exit 0

select_item "$selected"

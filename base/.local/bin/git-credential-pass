#!/usr/bin/env bash
# Git credential helper using pass (password-store).
#
# Pass entry format (e.g., at git/github.com):
#   <password or token>
#   username: <username>
#
# Usage in git config:
#   [credential]
#       helper = git-credential-pass

set -euo pipefail

cmd="${1:-}"

if [[ "$cmd" != "get" ]]; then
    exit 0
fi

input=$(cat)
host=$(grep "^host=" <<< "$input" | cut -d= -f2-)

[[ -z "$host" ]] && exit 1

# Validate host to prevent path traversal attacks
if [[ "$host" =~ [/\\] ]] || [[ "$host" == *..* ]]; then
    exit 1
fi

pass_entry="git/$host"

if ! pass show "$pass_entry" &>/dev/null; then
    exit 1
fi

pass_content=$(pass show "$pass_entry")
password=$(grep -v "^$" <<< "$pass_content" | grep -v "^username:" | head -n1 || true)
username=$(grep -E "^username:" <<< "$pass_content" | cut -d: -f2- | xargs || true)

[[ -n "$username" ]] && printf 'username=%s\n' "$username"
[[ -n "$password" ]] && printf 'password=%s\n' "$password"

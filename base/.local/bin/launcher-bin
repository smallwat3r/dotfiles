#!/usr/bin/env bash
#
# launcher-bin - Custom command launcher
#
# Interactively select and run a command from PATH, desktop applications,
# or installed Flatpak apps. Commands are sorted by usage frequency.
#
# Usage: launcher-bin [--refresh]
#
# Dependencies: fzf, flatpak (optional), gtk-launch (optional)
#
PATH="$HOME/.local/bin:$HOME/go/bin:$HOME/.cargo/bin:$PATH"
set -euo pipefail

. "${HOME}/.local/lib/launcher.sh"

require fzf

CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}"
CACHE_FILE="$CACHE_DIR/launcher-bin-commands"
HISTORY_FILE="$CACHE_DIR/launcher-bin-history"
CACHE_MAX_AGE=86400  # 1 day
HISTORY_MAX_LINES=50

is_flatpak() { has flatpak && flatpak info "$1" >/dev/null 2>&1; }
is_desktop() { [[ -f "/usr/share/applications/$1.desktop" ]] || \
               [[ -f "${HOME}/.local/share/applications/$1.desktop" ]]; }

trim_history() {
    [[ -f $HISTORY_FILE ]] || return 0
    local lines
    lines=$(wc -l < "$HISTORY_FILE")
    if (( lines > HISTORY_MAX_LINES )); then
        local tmp="${HISTORY_FILE}.tmp"
        tail -n "$HISTORY_MAX_LINES" "$HISTORY_FILE" > "$tmp" && mv "$tmp" "$HISTORY_FILE"
    fi
}

run() {
    echo "$1" >> "$HISTORY_FILE"
    trim_history
    if is_flatpak "$1"; then
        setsid flatpak run "$1" >/dev/null 2>&1 &
    elif is_desktop "$1"; then
        setsid gtk-launch "$1" >/dev/null 2>&1 &
    else
        setsid "$1" >/dev/null 2>&1 &
    fi
}

list_desktop_apps() {
    local dir f base
    for dir in /usr/share/applications ~/.local/share/applications; do
        [[ -d $dir ]] || continue
        for f in "$dir"/*.desktop; do
            [[ -f $f ]] || continue
            base="${f##*/}"
            echo "${base%.desktop}"
        done
    done
}

list_commands() {
    compgen -c
    list_desktop_apps
    if is_linux && has flatpak; then
        flatpak list --app --columns=application
    fi
}

cache_is_stale() {
    [[ ! -f $CACHE_FILE ]] && return 0
    local age
    age=$(( $(date +%s) - $(stat -c %Y "$CACHE_FILE" 2>/dev/null || echo 0) ))
    (( age > CACHE_MAX_AGE ))
}

refresh_cache() {
    list_commands | sort -u > "$CACHE_FILE"
}

get_commands() {
    if [[ "${1:-}" == "--refresh" ]] || cache_is_stale; then
        refresh_cache
    fi
    cat "$CACHE_FILE"
}

sort_by_frequency() {
    if [[ -f $HISTORY_FILE ]]; then
        awk -v hist="$HISTORY_FILE" '
            BEGIN { while ((getline line < hist) > 0) freq[line]++ }
            !seen[$0]++ { print freq[$0]+0, $0 }
        ' | sort -rn | cut -d' ' -f2-
    else
        cat
    fi
}

trap "" HUP

target="$(get_commands "${1:-}" | sort_by_frequency | fzf_pick)" || exit 0

[[ -n $target ]] && run "$target"

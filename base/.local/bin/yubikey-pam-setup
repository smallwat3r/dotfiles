#!/usr/bin/env bash
# Setup YubiKey U2F authentication for PAM (sudo, login, etc.)
# Requires: pam-u2f, pamu2fcfg packages

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info()  { echo -e "${GREEN}[INFO]${NC} $1"; }
warn()  { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

YUBICO_DIR="${HOME}/.config/Yubico"
U2F_KEYS="${YUBICO_DIR}/u2f_keys"

check_dependencies() {
    info "Checking dependencies..."
    if ! command -v pamu2fcfg &>/dev/null; then
        error "pamu2fcfg not found. Install with: sudo dnf install pam-u2f pamu2fcfg"
    fi
    if ! command -v ykman &>/dev/null; then
        warn "ykman not found. Install with: sudo dnf install yubikey-manager"
    fi
}

check_yubikey() {
    info "Checking for YubiKey..."
    if ! lsusb -d 1050: &>/dev/null; then
        error "No YubiKey detected. Please insert your YubiKey and try again."
    fi
    info "YubiKey detected."
}

generate_u2f_keys() {
    mkdir -p "${YUBICO_DIR}"

    if [[ -f "${U2F_KEYS}" ]]; then
        warn "Existing u2f_keys found at ${U2F_KEYS}"
        read -rp "Add another key (a) or overwrite (o)? [a/o]: " choice
        case "${choice}" in
            a|A)
                info "Touch your YubiKey when it blinks..."
                pamu2fcfg -n >> "${U2F_KEYS}"
                ;;
            o|O)
                info "Touch your YubiKey when it blinks..."
                pamu2fcfg > "${U2F_KEYS}"
                ;;
            *)
                error "Invalid choice. Aborting."
                ;;
        esac
    else
        info "Generating u2f_keys. Touch your YubiKey when it blinks..."
        pamu2fcfg > "${U2F_KEYS}"
    fi

    chmod 600 "${U2F_KEYS}"
    info "u2f_keys saved to ${U2F_KEYS}"
}

show_pam_instructions() {
    local hostname
    hostname=$(hostname)

    echo ""
    info "YubiKey registered. Now configure PAM."
    echo ""
    echo "Edit /etc/pam.d/sudo and add the highlighted line:"
    echo ""
    echo "  #%PAM-1.0"
    echo -e "  ${YELLOW}auth       sufficient   pam_u2f.so cue origin=pam://${hostname} appid=pam://${hostname}${NC}"
    echo "  auth       include      system-auth"
    echo "  ..."
    echo ""
    echo "Options:"
    echo "  - 'sufficient': Falls back to password if YubiKey absent"
    echo "  - 'required': Always requires YubiKey (can lock you out)"
    echo "  - 'cue': Shows 'Please touch the device' prompt"
    echo ""
    echo "To edit: sudo vi /etc/pam.d/sudo"
    echo ""
    echo "Test in a NEW terminal before closing your current session!"
}

main() {
    echo "YubiKey PAM U2F Setup"
    echo "====================="
    echo ""

    check_dependencies
    check_yubikey
    generate_u2f_keys
    show_pam_instructions
}

main "$@"

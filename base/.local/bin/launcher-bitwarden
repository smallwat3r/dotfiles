#!/usr/bin/env bash
#
# launcher-bitwarden - Bitwarden credential picker using rbw and fzf
#
# Interactively select a credential from your Bitwarden vault and copy
# a field (password, username, or TOTP) to the clipboard. The clipboard
# is automatically cleared after the first paste for security.
#
# Dependencies: rbw, fzf, jq, wl-copy/xclip/pbcopy
#
set -euo pipefail

. "${HOME}/.local/lib/launcher.sh"

require rbw fzf jq

history_file="${XDG_CACHE_HOME:-$HOME/.cache}/launcher-bitwarden-history"
history_max=50

record_history() {
    local entry="$1"
    local tmp_file
    mkdir -p "$(dirname "$history_file")"

    tmp_file="${history_file}.$$"
    {
        printf '%s\n' "$entry"
        if [[ -f $history_file ]]; then
            grep -vxF "$entry" "$history_file" 2>/dev/null | head -n "$((history_max - 1))" || true
        fi
    } > "$tmp_file" && mv -f "$tmp_file" "$history_file" || rm -f "$tmp_file"
}

load_history() {
    declare -gA history_rank
    [[ -f $history_file ]] || return
    local rank=1
    while IFS= read -r entry; do
        [[ -z ${history_rank[$entry]+x} ]] && history_rank[$entry]=$rank
        ((rank++))
    done < "$history_file"
}

clip_secret() {
    local content
    content=$(cat)
    printf '%s' "$content" | clip_secure
    # Remove from clipboard history if cliphist is available
    if has cliphist; then
        sleep 0.1
        cliphist delete-query "$content" >/dev/null 2>&1 || true
    fi
}

fzf_pick_item() {
    fzf --reverse --wrap --prompt="$1" --pointer=' ' --highlight-line --no-separator --no-scrollbar \
        --info=inline-right --bind="$FZF_BIND" --color="$FZF_COLORS"
}

list_items() {
    load_history
    for i in "${!items[@]}"; do
        IFS=$'\t' read -r name user <<< "${items[$i]}"
        local entry="$name${user:+	$user}"
        local rank=${history_rank[$entry]:-999999}

        if [[ -n $user ]]; then
            printf '%s\t%d\t[login] %s (%s)\n' "$rank" "$i" "$name" "$user"
        else
            printf '%s\t%d\t[note]  %s\n' "$rank" "$i" "$name"
        fi
    done | sort -t$'\t' -k1,1n | cut -f2-
}

get_fields() {
    local name="$1" user="$2"
    local raw pw un totp notes

    raw="$(rbw get --raw "$name" ${user:+"$user"} 2>/dev/null)" || return
    pw="$(jq -r '.data.password // empty' <<< "$raw" 2>/dev/null)" || true
    un="$(jq -r '.data.username // empty' <<< "$raw" 2>/dev/null)" || true
    notes="$(jq -r '.notes // empty' <<< "$raw" 2>/dev/null)" || true
    totp="$(rbw code "$name" ${user:+"$user"} 2>/dev/null || true)"

    [[ -n $pw ]] && fields[password]="$pw" || true
    [[ -n $un ]] && fields[username]="$un" || true
    [[ -n $notes ]] && fields[notes]="$notes" || true
    [[ -n $totp ]] && fields[totp]="$totp" || true
}

# Main

rbw unlocked 2>/dev/null || rbw unlock

mapfile -t items < <(rbw list --fields name,user)
(( ${#items[@]} )) || die "No items found in vault"

target="$(list_items | fzf_pick_item "rbw> " | cut -f1)" || exit 0
[[ -z $target ]] && exit 0

IFS=$'\t' read -r name user <<< "${items[$target]}"

declare -A fields
get_fields "$name" "$user"
(( ${#fields[@]} )) || die "No fields available"

if (( ${#fields[@]} == 1 )); then
    selected="${!fields[@]}"
else
    selected="$(printf '%s\n' "${!fields[@]}" | fzf_pick_item "field> ")" || exit 0
    [[ -z $selected ]] && exit 0
fi

printf '%s' "${fields[$selected]}" | clip_secret
record_history "$name${user:+	$user}"

#!/usr/bin/env bash
# Open file(s) in emacsclient.
# Creates a new frame if none exists, otherwise reuses the current frame.
# Usage: ec [file...]
set -euo pipefail

# Start daemon if not running and wait for it to be ready
if ! emacsclient -e '(progn)' &>/dev/null; then
  emacs --daemon &>/dev/null || true
  SECONDS=0  # Bash built-in that auto-increments each second
  while ! emacsclient -e '(progn)' &>/dev/null; do
    if ((SECONDS >= 10)); then
      echo "Error: Emacs daemon failed to start" >&2
      exit 1
    fi
    sleep 0.1
  done
fi

# Reuse existing frame if one exists, otherwise create a new one
has_gui_frame=$(emacsclient -e \
  '(cl-some (lambda (f) (frame-parameter f '\''window-system)) (frame-list))' 2>/dev/null)
if [[ "$has_gui_frame" != "nil" && -n "$has_gui_frame" ]]; then
  if [[ $# -eq 0 ]]; then
    # No files, just focus existing frame
    emacsclient -e '(select-frame-set-input-focus (selected-frame))' >/dev/null
  else
    emacsclient -n "$@"
  fi
else
  emacsclient -c -n "$@"
fi

#!/usr/bin/env bash
# Open file(s) in emacsclient.
# Creates a new frame if none exists, otherwise reuses the current frame.
# Usage: ec [file...]
set -euo pipefail

# Start daemon if not running and wait for it to be ready
if ! emacsclient -e '(progn)' &>/dev/null; then
  emacs --daemon &>/dev/null || true
  SECONDS=0  # Bash built-in that auto-increments each second
  while ! emacsclient -e '(progn)' &>/dev/null; do
    if ((SECONDS >= 10)); then
      echo "Error: Emacs daemon failed to start" >&2
      exit 1
    fi
    sleep 0.1
  done
fi

# Reuse existing visible GUI frame if one exists, otherwise create a new one
# The daemon creates an invisible frame by default - we only want visible GUI frames
# Note: Use (framep f) instead of (frame-parameter f 'window-system) because pgtk
# Emacs returns nil for window-system even on GUI frames. framep returns t for tty
# frames and the toolkit name (pgtk, x, ns, etc.) for GUI frames.
has_gui_frame=$(emacsclient -e \
  '(let ((found nil))
     (dolist (f (frame-list))
       (when (and (not (eq (framep f) t))
                  (eq (frame-visible-p f) t))
         (setq found f)))
     (when found (select-frame-set-input-focus found))
     (not (null found)))' 2>/dev/null)

if [[ "$has_gui_frame" == "t" ]]; then
  [[ $# -gt 0 ]] && emacsclient -n "$@"
else
  emacsclient -c -n "$@"
fi

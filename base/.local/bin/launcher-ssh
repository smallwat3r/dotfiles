#!/usr/bin/env bash
#
# launcher-ssh - SSH host picker
#
# Interactively select a host from ~/.ssh/config and connect to it.
#
# Dependencies: fzf, ssh
#
set -euo pipefail

. "${HOME}/.local/lib/launcher.sh"

require fzf ssh

SSH_CONFIGS=(
    "$HOME/.ssh/config"
    "$HOME/.ssh/work"
    "$HOME/.ssh/private"
)

list_hosts() {
    local configs=()
    for cfg in "${SSH_CONFIGS[@]}"; do
        [[ -f "$cfg" ]] && configs+=("$cfg")
    done
    [[ ${#configs[@]} -eq 0 ]] && die "No SSH config files found"

    awk '
        BEGIN { IGNORECASE = 1 }
        /^[Hh]ost / {
            for (i = 2; i <= NF; i++)
                if ($i !~ /[*?]/) { hosts[++n] = $i; current = $i }
        }
        /^[[:space:]]*[Hh]ost[Nn]ame/ { hostnames[current] = $2 }
        END {
            for (i = 1; i <= n; i++) {
                h = hosts[i]; hn = hostnames[h]
                if (hn && hn != h)
                    printf "%s\t%s (%s)\n", h, h, hn
                else
                    printf "%s\t%s\n", h, h
            }
        }
    ' "${configs[@]}"
}

fzf_pick_host() {
    fzf --reverse --wrap --tiebreak=index \
        --delimiter=$'\t' --with-nth=2.. \
        --prompt='' --pointer='' --highlight-line --no-separator --no-scrollbar --info=inline-right \
        --bind="$FZF_BIND" --color="$FZF_COLORS"
}

selected="$(list_hosts | fzf_pick_host)" || exit 0
[[ -z "$selected" ]] && exit 0

host="${selected%%$'\t'*}"

term="${TERMINAL:-foot}"
if [[ -n "$SWAYSOCK" ]]; then
    swaymsg exec "$term -e ssh $host"
else
    "$term" -e ssh "$host" &
    disown
fi

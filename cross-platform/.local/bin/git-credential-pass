#!/usr/bin/env bash
# Git credential helper using pass (password-store).
#
# Pass entry format (e.g., at git/github.com):
#   <password or token>
#   username: <username>
#
# Usage in git config:
#   [credential]
#       helper = git-credential-pass

set -euo pipefail

cmd="${1:-}"

if [[ "$cmd" != "get" ]]; then
    exit 0
fi

input=$(cat)
host=$(echo "$input" | grep "^host=" | cut -d= -f2-)

[[ -z "$host" ]] && exit 1

pass_entry="git/$host"

if ! pass show "$pass_entry" &>/dev/null; then
    exit 1
fi

pass_content=$(pass show "$pass_entry")
password=$(echo "$pass_content" | grep -v "^$" | grep -v "^username:" | head -n1 || true)
username=$(echo "$pass_content" | grep -E "^username:" | cut -d: -f2- | xargs || true)

[[ -n "$username" ]] && echo "username=$username"
[[ -n "$password" ]] && echo "password=$password"

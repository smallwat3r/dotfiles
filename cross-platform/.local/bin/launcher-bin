#!/usr/bin/env bash
# Custom command launcher
set -euo pipefail

# ignore SIGHUP so children survive when terminal exits (this is
# launched from a term as a command launcher)
trap "" HUP

if ! command -v fzf >/dev/null 2>&1; then
  echo 'You need to install fzf' >&2
  exit 1
fi

cmds="$(compgen -c | sort -u)"

# if Linux, also include Flatpak apps
if [[ "$(uname -s)" == "Linux" ]] && command -v flatpak >/dev/null 2>&1; then
  flatpaks="$(flatpak list --app --columns=application | sort -u)"
  cmds="$cmds"$'\n'"$flatpaks"
fi

target="$(
  printf '%s\n' "$cmds" | \
    fzf --reverse --color bg:-1,bg+:-1,fg+:186,hl:115,hl+:115
)" || exit 0

[ -n "$target" ] || exit 0

if command -v flatpak >/dev/null 2>&1 && flatpak info "$target" >/dev/null 2>&1; then
  flatpak run "$target" &
else
  "$target" &
fi

# ensure terminal launcher exits as well if script is done
exit 0

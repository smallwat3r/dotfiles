#!/usr/bin/env bash
# Custom command launcher
set -euo pipefail

# ignore SIGHUP so children survive when terminal exits (this is
# launched from a term as a command launcher)
trap "" HUP

if ! command -v fzf >/dev/null 2>&1; then
  echo 'You need to install fzf' >&2
  exit 1
fi

cmds="$(compgen -c | sort -u)"

# if Linux, also include Flatpak apps
if [[ $OSTYPE == linux* ]] && command -v flatpak >/dev/null 2>&1; then
  flatpaks="$(flatpak list --app --columns=application | sort -u)"
  cmds="$cmds"$'\n'"$flatpaks"
fi

target="$(
  printf '%s\n' "$cmds" |
  fzf \
    --reverse \
    --color=bg:-1,bg+:-1 \
    --color=fg:-1,fg+:-1 \
    --color=hl:33,hl+:33 \
    --color=info:30 \
    --color=prompt:30 \
    --color=pointer:32 \
    --color=marker:32 \
    --color=spinner:32
)" || exit 0

[ -n "$target" ] || exit 0

if command -v flatpak >/dev/null 2>&1 && flatpak info "$target" >/dev/null 2>&1; then
  flatpak run "$target" &
else
  "$target" &
fi

# ensure terminal launcher exits as well if script is done
exit 0

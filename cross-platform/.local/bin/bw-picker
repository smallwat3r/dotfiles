#!/usr/bin/env bash
#
# bw-picker - Bitwarden credential picker using rbw and fzf
#
# Interactively select a credential from your Bitwarden vault and copy
# a field (password, username, or TOTP) to the clipboard. The clipboard
# is automatically cleared after the first paste for security.
#
# Dependencies:
#   - rbw: Unofficial Bitwarden CLI (https://github.com/doy/rbw)
#   - fzf: Fuzzy finder
#   - wl-copy, xclip, or pbcopy: Clipboard utility
#
# Usage:
#   bw-picker
#
#   1. Select an item from the vault (logins show username, notes are labeled)
#   2. If multiple fields available, select which one to copy
#   3. Field is copied to clipboard and cleared after first paste
#
set -euo pipefail

die() { echo "$1" >&2; exit 1; }

has() { command -v "$1" >/dev/null 2>&1; }

require() { has "$1" || die "$1 is required"; }

require rbw
require fzf

# Clipboard with auto-clear after paste
if has wl-copy; then
  clip() { wl-copy --paste-once; }
elif has xclip; then
  clip() { xclip -selection clipboard -loops 1; }
elif has pbcopy; then
  clip() { pbcopy; (sleep 45 && pbcopy < /dev/null) & }
else
  die "No clipboard tool found (wl-copy, xclip, pbcopy)"
fi

case "$(uname -s)" in
  Darwin) fzf_bind="alt-left:backward-word,alt-right:forward-word,alt-bs:backward-kill-word,home:first,end:last" ;;
  *)      fzf_bind="ctrl-left:backward-word,ctrl-right:forward-word,ctrl-bs:backward-kill-word,home:first,end:last" ;;
esac

fzf_pick() {
  fzf --reverse --wrap --prompt="$1" --bind="$fzf_bind" \
    --color=bg:-1,bg+:-1,fg:-1,fg+:-1 \
    --color=hl:33,hl+:33,info:30,prompt:30 \
    --color=pointer:32,marker:32,spinner:32
}

rbw_get() {
  rbw get ${2:+--field "$2"} "$1" 2>/dev/null || true
}

# Ensure vault is unlocked
rbw unlocked 2>/dev/null || rbw unlock

# Select item
mapfile -t items < <(rbw list --fields name,user)
(( ${#items[@]} )) || die "No items found in vault"

target="$(
  for i in "${!items[@]}"; do
    IFS=$'\t' read -r name user <<< "${items[$i]}"
    [[ -n $user ]] && printf '%d\t[login] %s (%s)\n' "$i" "$name" "$user" \
                   || printf '%d\t[note]  %s\n' "$i" "$name"
  done | fzf_pick "rbw> " | cut -f1
)" || exit 0

[[ -z $target ]] && exit 0
IFS=$'\t' read -r name _ <<< "${items[$target]}"

# Select field
declare -A fields
for f in password username totp; do
  case $f in
    password) val="$(rbw_get "$name")" ;;
    username) val="$(rbw_get "$name" username)" ;;
    totp)     val="$(rbw code "$name" 2>/dev/null || true)" ;;
  esac
  [[ -n $val ]] && fields[$f]="$val"
done

(( ${#fields[@]} )) || die "No fields available"

if (( ${#fields[@]} == 1 )); then
  selected="${!fields[@]}"
else
  selected="$(printf '%s\n' "${!fields[@]}" | fzf_pick "field> ")" || exit 0
  [[ -z $selected ]] && exit 0
fi

printf '%s' "${fields[$selected]}" | clip

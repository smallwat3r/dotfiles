#!/usr/bin/env bash
#
# launcher-ssh - SSH host picker
#
# Interactively select a host from ~/.ssh/config and connect to it.
#
# Dependencies:
#   - fzf: Fuzzy finder
#   - ssh: OpenSSH client
#
# Usage:
#   launcher-ssh
#
set -euo pipefail

# Helpers

die() { echo "$1" >&2; exit 1; }

has() { command -v "$1" >/dev/null 2>&1; }

require() { has "$1" || die "$1 is required"; }

# Dependencies

require fzf
require ssh

# Config

SSH_CONFIG="${SSH_CONFIG:-$HOME/.ssh/config}"
[[ -f "$SSH_CONFIG" ]] || die "SSH config not found: $SSH_CONFIG"

case "$(uname -s)" in
  Darwin)
    fzf_bind="alt-left:backward-word,alt-right:forward-word,alt-bs:backward-kill-word,home:first,end:last"
    ;;
  *)
    fzf_bind="ctrl-left:backward-word,ctrl-right:forward-word,ctrl-bs:backward-kill-word,home:first,end:last"
    ;;
esac

fzf_colors="bg:-1,bg+:-1,fg:-1,fg+:-1,hl:33,hl+:33,info:30,prompt:30,pointer:32,marker:32,spinner:32"

# Functions

fzf_pick() {
  fzf --reverse --wrap --tiebreak=index \
    --delimiter=$'\t' --with-nth=2.. \
    --bind="$fzf_bind" --color="$fzf_colors"
}

list_hosts() {
  awk '
    BEGIN { IGNORECASE = 1 }
    /^[Hh]ost / {
      for (i = 2; i <= NF; i++)
        if ($i !~ /[*?]/) { hosts[++n] = $i; current = $i }
    }
    /^[[:space:]]*[Hh]ost[Nn]ame/ { hostnames[current] = $2 }
    END {
      for (i = 1; i <= n; i++) {
        h = hosts[i]; hn = hostnames[h]
        if (hn && hn != h)
          printf "%s\t%s (%s)\n", h, h, hn
        else
          printf "%s\t%s\n", h, h
      }
    }
  ' "$SSH_CONFIG"
}

# Main

selected="$(list_hosts | fzf_pick)" || exit 0
[[ -z "$selected" ]] && exit 0

host="${selected%%$'\t'*}"

exec ssh "$host"

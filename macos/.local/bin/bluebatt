#!/usr/bin/env bash
# Show battery levels of connected Bluetooth devices.
# Works with Magic Mouse, Magic Keyboard, etc.
# Usage: bluebatt [filter]
# Note: May not work with AirPods.

data=$(ioreg -r -k BatteryPercent | grep -E '("BatteryPercent"|"Product")')

output=""
name=""

while IFS= read -r line; do
  value=$(echo "$line" | xargs | sed 's/^.*= //')
  if [[ $line == *"Product"* ]]; then
    [[ -n $output ]] && output+=$'\n'
    name=$value
    output+="$name"
  else
    output+=": ${value}%"
  fi
done <<< "$data"

if [[ -n $1 ]]; then
  echo "$output" | grep -i "$1"
else
  echo "$output"
fi

#!/usr/bin/env bash
# Browse Chrome history using fzf.
# Requires: fzf, sqlite3
set -euo pipefail

command -v fzf >/dev/null || { echo "fzf required" >&2; exit 1; }

FZF_OPTS="--reverse --color=bg:-1,bg+:-1,fg+:186,hl:115,hl+:115"
HISTORY="$HOME/Library/Application Support/Google/Chrome/Default/History"

# Chrome locks the db, work from a copy
cp "$HISTORY" /tmp/chrome_history || exit 1

target=$(
  sqlite3 /tmp/chrome_history 'SELECT url FROM urls ORDER BY last_visit_time DESC LIMIT 100000' |
  FZF_DEFAULT_OPTS="$FZF_OPTS" fzf --preview 'echo {} | fold -s -w 50' --preview-window=right:70%
) || exit 0

rm -f /tmp/chrome_history
open -a "/Applications/Google Chrome.app" "$target"

#!/usr/bin/env bash
#
# launcher-yubikey-otp - YubiKey OATH TOTP code picker
#
# Interactively select an OATH account from your YubiKey and copy the code
# to clipboard.
#
# Dependencies: fzf, ykman, wl-copy
#
set -euo pipefail

. "${HOME}/.local/lib/launcher.sh"

require fzf ykman

list_accounts() {
    ykman oath accounts list 2>/dev/null || die "No YubiKey detected"
}

selected="$(list_accounts | fzf_pick)" || exit 0
[[ -z "$selected" ]] && exit 0

code="$(ykman oath accounts code -s "$selected" 2>/dev/null)" || die "Failed to get code"
[[ -z "$code" ]] && die "Empty code"

printf '%s' "$code" | clip
